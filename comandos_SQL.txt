-- VIEW

CREATE VIEW ranking_turmas AS
SELECT 
  ROW_NUMBER() OVER (ORDER BY AVG(A.nota) DESC) AS contador,
  D.nome AS nome_disciplina,
  T.nome_turma,
  AVG(A.nota) AS media_avaliacao,
  COUNT(A.id) AS quantidade_avaliacoes
FROM Turmas T
JOIN Disciplinas D ON T.fk_id_disciplina = D.id
JOIN Avaliacoes A ON T.id = A.fk_id_turma
GROUP BY T.id, D.nome;


-- PROCEDURE

CREATE DEFINER=`root`@`localhost` PROCEDURE `AvaliarDenunciaComentarioOfensivo`(
    IN denuncia_id INT,
    IN acao VARCHAR(10) -- 'ignorar', 'aceitar'
)
BEGIN
   DECLARE avaliacao_id INT;
   
   -- Obter ID da avaliação associada à denúncia
    SELECT id_avaliacao INTO avaliacao_id
    FROM Denuncias
    WHERE id = denuncia_id;
    
    IF acao = 'ignorar' THEN
    DELETE FROM Denuncias 
    WHERE id = denuncia_id;
    
    ELSEIF acao = 'aceitar' THEN
        -- Aceitar a denúncia e excluir a avaliação associada
        DELETE FROM Avaliacoes
        WHERE id = avaliacao_id;
        -- Excluir a denúncia da tabela Denuncias
        DELETE FROM Denuncias
        WHERE id = denuncia_id;
    END IF;
END
